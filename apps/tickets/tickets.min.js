"use strict";!function(e){function t(){e(r).addClass("sb-collapsing"),setTimeout(function(){e(r).removeClass("sb-collapsing")},1e3)}function s(e){if(void 0===e)return window.sb_current_user;window.sb_current_user=e}function i(e){return SBF.translate(e)}function n(){0!=s()&&e(v).setProfile("#"==s().get("last_name").charAt(0)?i("Account"):s().name)}function a(e=!1){let t="";l((t=e&&"title"in e.details&&!SBF.null(e.details.title)?e.get("title"):SBF.setting("tickets_conversation_name"))&&-1!=t?t:s().name)}function o(){let t="",n=SBForm.getAll(b),a="department"in n?n.department[0]:null,o=[];SBChat.clear(),SBChat.activateBar(!1);for(var l in n)n[l][1]&&n[l][0]&&(t+=`*${i(n[l][1])}*\n${"department"==l?b.find("#department li.sb-active").html():n[l][0]}\n\n`);t+=e(f).find("textarea").val().trim(),b.find(".sb-attachments > div").each(function(){o.push([e(this).attr("data-name"),e(this).attr("data-value")])}),s()?SBChat.newConversation(2,-1,t,o,a,null,function(){k.welcome()}):SBChat.addUserAndLogin(()=>{SBChat.newConversation(2,-1,t,o,a,null,function(){k.welcome()})})}function l(t){e(h).html(t).sbActive(t)}var r,c,d,b,f,g,p,h,u,v,m,S={},B={},w=e(window).width()<426,C=!1,k={showPanel:function(t="",s=!1){let n=g;switch(g=t,e(r).addClass("sb-panel-active sb-load").removeClass("sb-panel-form").attr("data-panel",t),C&&C.hide(),t){case"privacy":SBF.ajax({function:"get-block-setting",value:"privacy"},t=>{l(i(t.title)),e(b).append(`<div class="sb-privacy sb-init-form" data-decline="${i(t.decline.replace(/"/g,""))}"><div class="sb-text">${i(t.message)}</div>`+(""!=t.link?`<a target="_blank" href="${t.link}">${i(t["link-name"])}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${i(t["btn-approve"])}</a><a class="sb-btn sb-decline">${i(t["btn-decline"])}</a></div></div>`)}),this.showSidePanels(!1);break;case"articles":l(i(0==s?"Articles":s)),this.showSidePanels(!1);break;case"edit-profile":case"login":case"registration":let p="edit-profile"==t;this.showSidePanels(!1),e(r).addClass("sb-panel-form"),t in B?(e(b).html(B[t]),l(i(e(b).find(".sb-top").html()))):(SBF.ajax({function:"get-rich-message",name:(p?"registration":t)+"-tickets"},s=>{e(b).html(s);let n=e(b).find(".sb-top").html();p&&e(b).find(".sb-top").html(i("Edit profile")),l(i(n)),setTimeout(function(){l(i(n))},300),e(b).find(".sb-link-area").insertAfter(".sb-buttons"),e(b).find(".sb-info").insertBefore(".sb-buttons"),B[t]=e(b).html()}),e(b).html('<div class="sb-loading"></div>'));break;case"new-ticket":let h={title:"Title",message:"Message",panel:"Create a new ticket",button:"Create a new ticket"};if(this.showSidePanels(!1),SBF.setting("tickets_names")){let e=SBF.setting("tickets_names");for(var o in e)e[o]&&(h[o.replace("tickets-names-","")]=e[o])}l(i(h.panel)),e(b).html(`<div class="sb-info"></div><div class="sb-input sb-input-text sb-ticket-title"><span>${i(h.title)}</span><input type="text" required></div>${e(r).find(".sb-ticket-fields").html()}<div class="sb-input sb-editor-cnt"><span>${i(h.message)}</span></div><div class="sb-btn sb-icon sb-create-ticket"><i class="sb-icon-plus"></i>${i(h.button)}</div>`),e(c).find(".sb-editor-cnt").append(f),SBF.setting("tickets_recaptcha")&&(C?C.show():e.getScript("https://www.google.com/recaptcha/api.js?render="+SBF.setting("tickets_recaptcha"),()=>{setTimeout(()=>{C=e(".grecaptcha-badge")},500)}));break;default:this.showSidePanels(!0),"new-ticket"==n&&(e(f).removeClass("sb-error"),e(f).find("textarea").val(""),e(f).find(".sb-bar").sbActive(!1),e(d).after(f)),e(b).html(""),e(r).removeClass("sb-panel-active sb-load").removeAttr("data-panel"),a(SBChat.conversation)}SBF.event("SBPanelActive",t),setTimeout(function(){e(r).removeClass("sb-load")},300)},showSidePanels:function(s=!0){let i=e(r).find(".sb-btn-collapse");if(t(),!s||m>800){let t=e(r).find(".sb-panel-left,.sb-panel-right");s?t.removeClass("sb-collapsed"):t.addClass("sb-collapsed")}else m<=800&&e(i).sbActive(!0);e(i).css("display",s?"":"none")},setAgent:function(t){let s=e(r).find(".sb-agent-label").sbActive(!1);if(SBChat.agent_id=t,t in S){let i=S[t];e(u).setProfile(i.name,i.image).sbActive(!0),"details"in i&&SBF.getLocationTimeString(i.extra,t=>{e(s).html((""!=i.get("flag")?`<img src="${SB_URL}/media/flags/${i.get("flag")}">`:'<i class="sb-icon sb-icon-marker"></i>')+t).sbActive(!0)})}else SBF.ajax({function:"get-agent",agent_id:t},e=>{0!=e&&(S[t]=new SBUser(e),this.setAgent(t))})},activateConversation:function(t){if(t instanceof SBConversation){let n=SBChat.lastAgent(),o=["id","creation_time","last_update"],l="";this.selectConversation(t.id),a(t),e(r).find(".sb-panel-right .sb-scroll-area > div").sbActive(!1),n?(e(u).setProfile(n.full_name,n.profile_image),this.setAgent(n.user_id),setTimeout(function(){SBChat.updateUsersActivity()},300)):e(u).sbActive(!1),""!=t.get("department")&&SBChat.getDepartmentCode(t.get("department"),t=>{let s=e(r).find(".sb-department");e(s).html(`<span class="sb-title">${e(s).data("label")}</span>${t}`).sbActive(!0)});for(s=0;s<o.length;s++){let e;switch(o[s]){case"id":e=["padlock",i("Ticket ID"),t.id];break;case"creation_time":e=["calendar",i("Creation time"),SBF.beautifyTime(t.get("creation_time"),!0)];break;case"last_update":e=["reload",i("Last update"),SBF.beautifyTime(t.getLastMessage()?t.getLastMessage().get("creation_time"):t.get("last_update_time"),!0)]}l+=`<div data-id="${o[s]}"><i class="sb-icon sb-icon-${e[0]}"></i><span>${e[1]}</span><div>${e[2]}</div></div>`}e(r).find(".sb-ticket-details").html(l);let c=t.getAttachments();l="";for(var s=0;s<c.length;s++)l+=`<a href="${c[s][1]}" target="_blank"><i class="sb-icon sb-icon-file"></i>${c[s][0]}</a>`;e(r).find(".sb-conversation-attachments").html((l?`<div class="sb-title">${i("Attachments")}</div>`:"")+l),e(d).sbLoading(!1)}else SBF.error("Value not of type SBConversation","activateConversation")},selectConversation:function(t){let s=e(p).find(`[data-conversation-id="${t}"]`);e(p).find("> li").sbActive(!1),1==e(s).attr("data-conversation-status")&&e(s).attr("data-conversation-status",0),e(s).sbActive(!0)},getActiveConversation:function(t=""){let s=e(p).find(" > .sb-active");return!!s.length&&("ID"==t?e(s).attr("data-conversation-id"):s)},welcome:function(){SBF.setting("tickets_welcome_active")&&!SBF.storage("tickets-welcome")&&setTimeout(()=>{SBChat.sendMessage(SBF.setting("bot_id"),SBF.setting("tickets_welcome_message")),SBF.storage("tickets-welcome",!0)},1e3)},init:function(){if(r=e("body").find(".sb-tickets"),c=e(r).find(" > div > .sb-panel-main"),b=e(c).find(".sb-panel"),f=e(c).find(".sb-editor"),h=e(c).find(" > .sb-top .sb-title"),p=e(r).find(".sb-user-conversations"),d=e(c).find(".sb-list"),u=e(r).find(".sb-profile-agent"),v=e(r).find(".sb-panel-right > .sb-top .sb-profile"),m=e(r).width(),e(r).on("click",".sb-btn-collapse",function(){t(),e(r).find(".sb-panel-"+(e(this).hasClass("sb-left")?"left":"right")).toggleClass("sb-collapsed"),e(this).toggleClass("sb-active")}),e(f).on("focus focusout","textarea",function(){e(this).parent().parent().toggleClass("sb-focus")}),w||(e(f).on("click",".sb-btn-emoji",function(){let t="new-ticket"==g?[b,"padding-top",415]:[r,"margin-top",335];if(e(f).find(".sb-emoji").sbActive()){let s=e(this).offset().top+e(t[0])[0].scrollTop-window.scrollY,i=e(r).offset().top-window.scrollY;s-i<380&&e(t[0]).css(t[1],t[2]-(s-i)+"px")}else e(t[0]).css(t[1],"")}),e(f).on("click",".sb-emoji-list > ul > li",function(){let t="new-ticket"==g?[b,"padding-top",415]:[r,"margin-top",335];e(t[0]).css(t[1],"")})),e(c).on("click","> .sb-top .sb-close",function(){k.showPanel()}),e(c).on("click",".sb-create-ticket",function(){let t=!1;if(e(f).removeClass("sb-error"),SBForm.errors(b)&&(SBForm.showErrorMessage(b,"Please fill in all the required fields."),t=!0),e(f).find("textarea").val().trim()||(t||SBForm.showErrorMessage(b,"Please write a message."),e(f).addClass("sb-error"),t=!0),!t&&!SBChat.is_busy){if(SBChat.busy(!0),SBF.setting("tickets_recaptcha"))return void grecaptcha.ready(function(){grecaptcha.execute(SBF.setting("tickets_recaptcha"),{action:"submit"}).then(function(t){SBF.ajax({function:"recaptcha",token:t},t=>{!0===t?(o(),e(".grecaptcha-badge").hide()):SBChat.busy(!1)})})});o()}}),e(r).on("click",".sb-new-ticket",function(){k.showPanel("new-ticket")}),e(p).on("click","li",function(){SBChat.clear(),k.selectConversation(e(this).attr("data-conversation-id")),e(d).sbLoading(!0),w&&e(r).find(".sb-panel-left").addClass("sb-collapsed")}),e(r).find(".sb-panel-left .sb-search-btn input").on("input",function(){let t=e(this).val();SBF.search(t,()=>{t.length>1?SBF.ajax({function:"search-user-conversations",search:t},t=>{let n=[],a=t.length;for(var o=0;o<a;o++)n.push(new SBConversation([new SBMessage(t[o])],{id:t[o].conversation_id,title:t[o].title,status_code:t[o].status_code}));e(p).html(a?s().getConversationsCode(n):i("No results found."))}):SBChat.populateConversations()})}),e(r).on("click",".sb-panel-left .sb-search-btn i",function(){SBF.searchClear(this,()=>{SBChat.populateConversations()})}),e(b).on("click",".sb-login-area",function(){k.showPanel("login")}),e(b).on("click",".sb-registration-area",function(){k.showPanel("registration")}),e(r).on("click",'.sb-profile-menu [data-value="edit-profile"]',function(){k.showPanel("edit-profile")}),e(r).on("click",'.sb-profile-menu [data-value="logout"]',function(){SBF.logout(!1),k.showPanel("login")}),e(b).on("click","> .sb-buttons .sb-submit",function(){if(!e(this).sbLoading()){let t=SBForm.getAll(b),i=SBForm.getAll(b.find(".sb-form-extra")),a="edit-profile"==g;SBForm.errors(b)?SBForm.showErrorMessage(b,SBForm.getRegistrationErrorMessage(b)):(e(this).sbLoading(!0),t.user_type=["user",""],SBF.ajax({function:a||s()?"update-user":"add-user-and-login",settings:t,settings_extra:i},o=>{if(o&&!SBF.errorValidation(o)){if(SBF.loginCookie(o[1]),s()){for(var l in t)s().set(l,t[l][0]);for(var l in i)s().setExtra(l,i[l][0])}else{s(new SBUser(o[0]));for(var l in i)s().setExtra(l,i[l][0]);SBPusher.start(),SBChat.initChat()}n(),a?k.showPanel():(SBF.event("SBRegistrationForm",{user:t}),SBF.event("SBNewEmailAddress",{name:s().name,email:s().get("email")}),k.showPanel("new-ticket")),SBF.setting("wp_registration")&&"email"in t&&"password"in t?(console.log(t),SBApps.wordpress.ajax("wp_registration",{user_id:o[0].id,first_name:o[0].first_name,last_name:o[0].last_name,password:t.password[0],email:t.email[0]})):"wp"==SBF.setting("wp_users_system")&&SBApps.wordpress.ajax("wp_login",{user:t.email[0],password:t.password[0]})}else SBForm.showErrorMessage(b,SBForm.getRegistrationErrorMessage(o,"response"));e(this).sbLoading(!1)}))}}),e(b).on("click",".sb-submit-login",function(){SBF.loginForm(this,b,t=>{s(new SBUser(t[0])),n(),SBChat.populateConversations(t=>{0==t.length?(e(r).addClass("sb-no-conversations"),k.showPanel("new-ticket")):(SBChat.openConversation(t[0].id),k.showPanel())})})}),!r.length)return;if(!SBF.setting("tickets_registration_required")||s()&&!["visitor","lead"].includes(s().type))SBF.setting("welcome")&&!SBF.setting("tickets_hide")||s()&&s().conversations.length?s()&&s().conversations.length&&!k.getActiveConversation()?SBChat.openConversation(SBF.getURL("conversation")?SBF.getURL("conversation"):s().conversations[0].id):SBF.setting("welcome")&&a():(e(r).addClass("sb-no-conversations"),SBF.setting("privacy")&&!SBF.storage("privacy_approved")?k.showPanel("privacy"):SBF.setting("tickets_disable_first")||k.showPanel("new-ticket"));else{let t=SBF.setting("tickets_registration_redirect");if(t)return void(document.location=t+(t.includes("?")?"&":"?")+"sb=true");e(r).addClass("sb-no-conversations"),k.showPanel(SBF.setting("tickets_default_form"))}let l=parseInt(SBF.null(e(r).data("height"))?e(window).height():e(r).data("height")),S=parseInt(SBF.null(e(r).data("offset"))?0:e(r).data("offset"));m<=800?(e(r).addClass("sb-800"),e(r).find(".sb-panel-left,.sb-panel-right").addClass("sb-collapsed"),e(r).find(".sb-btn-collapse").sbActive(!0)):m<=1e3?e(r).addClass("sb-1000"):m<=1300&&e(r).addClass("sb-1300"),n(),e(r).removeClass("sb-loading").find(".sb-tickets-area").attr("style",`height: ${l-S}px`),setTimeout(function(){e(r).removeClass("sb-load")},300),SBChat.startRealTime(),SBF.event("SBTicketsInit")},onMessageSent:function(){if("new-ticket"==g){let t=e(c).find(".sb-ticket-title input").val();SBChat.updateConversations(),e(r).find(".sb-panel-right .sb-scroll-area > div").sbActive(!1),e(r).find(".sb-conversation-attachments,.sb-ticket-details").html(""),e(r).removeClass("sb-no-conversations"),k.showPanel(),l(t)}},onNewConversationReceived:function(e){e.id==SBChat.conversation.id&&k.getActiveConversation("ID")!=e.id&&setTimeout(()=>{k.activateConversation(SBChat.conversation)},300)},onNewMessageReceived:function(t){if(t instanceof SBMessage&&t.get("conversation_id")==SBChat.conversation.id){let s=SBChat.lastAgent(),i=SBChat.conversation.getCode(),n=k.getActiveConversation();n?e(n).html(i):e(p).append(`<li data-conversation-id="${SBChat.conversation.id}" class="sb-active">${i}</li>`).find(" > p").remove(),s&&SBF.isAgent(t.get("user_type"))&&s.id!=t.get("user_id")&&k.setAgent(t.get("user_id"))}}};window.SBTickets=k}(jQuery);